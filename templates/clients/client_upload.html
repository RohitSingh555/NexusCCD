{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Upload Clients{% endblock %}

{% block content %}
<div class="min-h-screen bg-neutral-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center shadow-sm">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Upload Clients</h1>
                        <p class="text-sm text-gray-600">Import client data from CSV or Excel files</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <a href="{% url 'clients:list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Back to Clients
                    </a>
                </div>
            </div>
        </div>

        <!-- Information Section -->
        <div class="mb-6 bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Bulk Client Upload & Update</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="flex items-start space-x-2">
                            <div class="w-6 h-6 bg-green-100 rounded flex items-center justify-center flex-shrink-0">
                                <svg class="w-3 h-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold text-gray-900">CSV Format</h4>
                                <p class="text-xs text-gray-600">Upload comma-separated values</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-2">
                            <div class="w-6 h-6 bg-blue-100 rounded flex items-center justify-center flex-shrink-0">
                                <svg class="w-3 h-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold text-gray-900">Excel Format</h4>
                                <p class="text-xs text-gray-600">Upload .xlsx or .xls files</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-2">
                            <div class="w-6 h-6 bg-orange-100 rounded flex items-center justify-center flex-shrink-0">
                                <svg class="w-3 h-3 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold text-gray-900">Data Validation</h4>
                                <p class="text-xs text-gray-600">Automatic duplicate detection</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Card -->
        <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 overflow-hidden">
            <!-- Upload Area -->
            <div class="p-8" x-data="uploadManager()">
                {% csrf_token %}
                
                <!-- Source Selection -->
                <div class="mb-8">
                    <h3 class="text-lg font-bold text-neutral-900 font-header mb-4">Select Data Source</h3>
                    <p class="text-sm text-neutral-600 font-body mb-4">Choose the source system for the client data you're uploading:</p>
                    <div class="flex space-x-4">
                        <label class="flex items-center p-4 border-2 border-neutral-200 rounded-lg cursor-pointer hover:border-brand-sky transition-all duration-200" 
                               :class="{ 'border-brand-sky bg-brand-sky/5': selectedSource === 'SMIMS' }">
                            <input type="radio" name="source" value="SMIMS" x-model="selectedSource" class="sr-only">
                            <div class="flex items-center space-x-3">
                                <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center" 
                                     :class="{ 'border-brand-sky bg-brand-sky': selectedSource === 'SMIMS', 'border-neutral-300': selectedSource !== 'SMIMS' }">
                                    <div x-show="selectedSource === 'SMIMS'" class="w-2 h-2 bg-white rounded-full"></div>
                                </div>
                                <div>
                                    <div class="font-bold text-neutral-900">SMIMS</div>
                                    <div class="text-sm text-neutral-600">Select for SMIMS system data</div>
                                </div>
                            </div>
                        </label>
                        
                        <label class="flex items-center p-4 border-2 border-neutral-200 rounded-lg cursor-pointer hover:border-brand-sky transition-all duration-200" 
                               :class="{ 'border-brand-sky bg-brand-sky/5': selectedSource === 'EMHware' }">
                            <input type="radio" name="source" value="EMHware" x-model="selectedSource" class="sr-only">
                            <div class="flex items-center space-x-3">
                                <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center" 
                                     :class="{ 'border-brand-sky bg-brand-sky': selectedSource === 'EMHware', 'border-neutral-300': selectedSource !== 'EMHware' }">
                                    <div x-show="selectedSource === 'EMHware'" class="w-2 h-2 bg-white rounded-full"></div>
                                </div>
                                <div>
                                    <div class="font-bold text-neutral-900">EMHware</div>
                                    <div class="text-sm text-neutral-600">Select for EMHware system data</div>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
                <!-- File Drop Zone -->
                <div 
                    class="border-2 border-dashed border-neutral-300 rounded-xl p-12 text-center transition-all duration-300 hover:border-brand-sky hover:bg-brand-sky/5"
                    :class="{ 'border-brand-sky bg-brand-sky/10': isDragging, 'border-green-500 bg-green-50': fileSelected }"
                    @dragover.prevent="isDragging = true"
                    @dragleave.prevent="isDragging = false"
                    @drop.prevent="handleFileDrop($event)"
                    @click="openFileDialog()"
                >
                    <input 
                        type="file" 
                        x-ref="fileInput"
                        @change="handleFileSelect($event)"
                        accept=".csv,.xlsx,.xls"
                        class="hidden"
                    >
                    
                    <!-- Upload Icon -->
                    <div class="mx-auto w-16 h-16 mb-4" :class="{ 'animate-bounce': isDragging }">
                        <svg class="w-full h-full text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                    </div>
                    
                    <!-- Upload Text -->
                    <div x-show="!fileSelected">
                        <h3 class="text-xl font-bold text-neutral-900 font-header mb-2">Drop files here or click to browse</h3>
                        <p class="text-neutral-600 font-body mb-4">Support for CSV, XLSX, and XLS files</p>
                        <div class="inline-flex items-center px-4 py-2 bg-brand-sky text-white text-sm font-bold rounded-lg">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Choose File
                        </div>
                    </div>
                    
                    <!-- Selected File -->
                    <div x-show="fileSelected" class="space-y-4">
                        <div class="flex items-center justify-center">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-green-800 font-header">File Selected</h3>
                            <p class="text-green-600 font-body" x-text="selectedFile?.name"></p>
                            <p class="text-sm text-green-500 font-body" x-text="formatFileSize(selectedFile?.size)"></p>
                        </div>
                        <button @click="clearFile()" class="text-sm text-red-600 hover:text-red-800 font-bold">
                            Remove file
                        </button>
                    </div>
                </div>

                <!-- Error Display -->
                <div x-show="errorMessage" class="mt-8">
                    <div class="bg-red-50 border border-red-200 rounded-xl p-6">
                        <div class="flex items-center mb-4">
                            <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-bold text-red-800 font-header">Upload Failed</h3>
                        </div>
                        <div class="text-red-700 font-body" x-html="errorMessage"></div>
                        <div class="mt-4">
                            <button @click="errorMessage = ''" class="inline-flex items-center px-4 py-2 bg-red-600 text-white text-sm font-bold rounded-lg hover:bg-red-700 transition-colors duration-200">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                Dismiss
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Upload Progress -->
                <div x-show="isUploading" class="mt-8 space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                        <div class="flex items-center mb-4">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
                            <h3 class="text-lg font-bold text-blue-800 font-header">Processing Upload...</h3>
                        </div>
                        
                        <!-- Progress Steps -->
                        <div class="space-y-3">
                            <div class="flex items-center" :class="{ 'text-green-600': currentStep >= 1, 'text-blue-600': currentStep === 1, 'text-neutral-400': currentStep < 1 }">
                                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center mr-3" 
                                     :class="{ 'bg-green-500 border-green-500 text-white': currentStep > 1, 'bg-blue-500 border-blue-500 text-white': currentStep === 1, 'border-current': currentStep < 1 }">
                                    <svg x-show="currentStep > 1" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span x-show="currentStep <= 1" class="text-xs font-bold">1</span>
                                </div>
                                <span class="font-body">Validating file format...</span>
                            </div>
                            
                            <div class="flex items-center" :class="{ 'text-green-600': currentStep >= 2, 'text-blue-600': currentStep === 2, 'text-neutral-400': currentStep < 2 }">
                                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center mr-3" 
                                     :class="{ 'bg-green-500 border-green-500 text-white': currentStep > 2, 'bg-blue-500 border-blue-500 text-white': currentStep === 2, 'border-current': currentStep < 2 }">
                                    <svg x-show="currentStep > 2" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span x-show="currentStep <= 2" class="text-xs font-bold">2</span>
                                </div>
                                <span class="font-body">Reading and parsing data...</span>
                            </div>
                            
                            <div class="flex items-center" :class="{ 'text-green-600': currentStep >= 3, 'text-blue-600': currentStep === 3, 'text-neutral-400': currentStep < 3 }">
                                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center mr-3" 
                                     :class="{ 'bg-green-500 border-green-500 text-white': currentStep > 3, 'bg-blue-500 border-blue-500 text-white': currentStep === 3, 'border-current': currentStep < 3 }">
                                    <svg x-show="currentStep > 3" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span x-show="currentStep <= 3" class="text-xs font-bold">3</span>
                                </div>
                                <span class="font-body">Processing client records...</span>
                            </div>
                            
                            <div class="flex items-center" :class="{ 'text-green-600': currentStep >= 4, 'text-blue-600': currentStep === 4, 'text-neutral-400': currentStep < 4 }">
                                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center mr-3" 
                                     :class="{ 'bg-green-500 border-green-500 text-white': currentStep > 4, 'bg-blue-500 border-blue-500 text-white': currentStep === 4, 'border-current': currentStep < 4 }">
                                    <svg x-show="currentStep > 4" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span x-show="currentStep <= 4" class="text-xs font-bold">4</span>
                                </div>
                                <span class="font-body">Saving to database...</span>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="mt-6">
                            <div class="bg-blue-200 rounded-full h-2 overflow-hidden">
                                <div class="bg-blue-500 h-2 rounded-full transition-all duration-500 ease-out" 
                                     :style="`width: ${(currentStep / 4) * 100}%`"></div>
                            </div>
                            <p class="text-sm text-blue-600 font-body mt-2 text-center" x-text="`${Math.round((currentStep / 4) * 100)}% Complete`"></p>
                        </div>
                    </div>
                </div>

                <!-- Upload Button -->
                <div class="mt-8 flex justify-center">
                    <button 
                        @click="uploadFile()" 
                        :disabled="!fileSelected || !selectedSource || isUploading"
                        class="px-8 py-3 bg-brand-sky text-white text-lg font-bold rounded-xl hover:bg-brand-darkBlue focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-sky transition-all duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                        :class="{ 'animate-pulse': isUploading }"
                    >
                        <span x-show="!isUploading">Upload Clients</span>
                        <span x-show="isUploading" class="flex items-center">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Processing...
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Instructions Card -->
        <div class="mt-8 bg-white rounded-2xl shadow-sm border border-neutral-200 overflow-hidden">
            <div class="p-8">
                <h2 class="text-xl font-bold text-neutral-900 font-header mb-6">File Format Requirements</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Required Columns -->
                    <div>
                        <h3 class="text-lg font-bold text-neutral-800 font-subheader mb-4">Required Columns</h3>
                        <div class="space-y-2">
                            <div class="flex items-center text-sm text-neutral-700 font-body">
                                <div class="w-2 h-2 bg-red-500 rounded-full mr-3"></div>
                                <span class="font-semibold">First Name</span> (or first_name, firstname, fname, given name)
                            </div>
                            <div class="flex items-center text-sm text-neutral-700 font-body">
                                <div class="w-2 h-2 bg-red-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Last Name</span> (or last_name, lastname, lname, surname, family name)
                            </div>
                            <div class="flex items-center text-sm text-neutral-700 font-body">
                                <div class="w-2 h-2 bg-red-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Phone</span> (or phone_number, telephone, tel, mobile, cell)
                            </div>
                            <div class="flex items-center text-sm text-neutral-700 font-body">
                                <div class="w-2 h-2 bg-red-500 rounded-full mr-3"></div>
                                <span class="font-semibold">DOB</span> (or dob, date of birth, birthdate, birth date) - YYYY-MM-DD format
                            </div>
                        </div>
                    </div>
                    
                    <!-- Optional Columns -->
                    <div>
                        <h3 class="text-lg font-bold text-neutral-800 font-subheader mb-4">Optional Columns</h3>
                        <div class="space-y-2">
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Email</span> (or e-mail, email address, e_mail)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Client ID</span> (or client_id, clientid, id, client number)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Middle Name</span> (or middle_name, middlename, mname)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Preferred Name</span> (or preferred_name, preferredname, nickname)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Alias/Last Name at Birth</span> (or alias, maiden name)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Age</span>
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Gender</span> (or sex) - defaults to "Unknown"
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Gender Identity</span> (or gender_identity, genderidentity)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Pronoun</span> (or pronouns, preferred pronoun)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Marital Status</span> (or marital_status, maritalstatus)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Citizenship Status</span> (or citizenship_status, citizenship)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Location/County</span> (or location/county, location, county)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Province</span> (or state)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-semibold">City</span> (or town)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Postal Code</span> (or postal_code, zip, zip code)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Address</span> (or street address, street)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Address 2</span> (or address_2, address2, apt, apartment, suite)
                            </div>
                        </div>
                    </div>
                    
                    <!-- Language & Identity Columns -->
                    <div>
                        <h3 class="text-lg font-bold text-neutral-800 font-subheader mb-4">Language & Identity Columns</h3>
                        <div class="space-y-2">
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Language</span> (or language, languages) - comma-separated
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Preferred Language</span> (or preferred_language, preferredlanguage)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Mother Tongue</span> (or mother_tongue, mothertongue, native language)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Official Language</span> (or official_language, officiallanguage)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Language Interpreter Required</span> (or interpreter required, interpreter)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Self-Identification as Race/Ethnicity</span> (or race/ethnicity, race ethnicity)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Ethnicity</span> (or ethnic background) - comma-separated
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Aboriginal Status</span> (or aboriginal_status, indigenous status, indigenous)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                <span class="font-semibold">LGBTQ+?</span> (or lgbtq, lgbtq+, sexual orientation)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Highest Level of Education</span> (or education level, education)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Children Home</span> (or children_home, childrenhome, has children)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Children Number</span> (or children_number, childrennumber, number of children)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                <span class="font-semibold">LHIN</span> (or local health integration network)
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contact & Medical Columns -->
                    <div>
                        <h3 class="text-lg font-bold text-neutral-800 font-subheader mb-4">Contact & Medical Columns</h3>
                        <div class="space-y-2">
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Phone (Work)</span> (or phone_work, work phone, workphone)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Phone (Alt)</span> (or phone_alt, alternative phone, alt phone)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Permission to Phone</span> (or permission_to_phone, phone permission) - true/false/yes/no/1/0
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Permission to Email</span> (or permission_to_email, email permission) - true/false/yes/no/1/0
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Medical Conditions</span> (or medical_conditions, health conditions)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Primary Diagnosis</span> (or primary_diagnosis, diagnosis)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Family Doctor</span> (or family_doctor, doctor, physician)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <span class="font-semibold">HC</span> (or health_card, health card number)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <span class="font-semibold">HC Version</span> (or health_card_version, health card version)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <span class="font-semibold">HC Exp Date</span> (or health_card_exp_date, health card expiry)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <span class="font-semibold">HC Issuing Province</span> (or health_card_issuing_province)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <span class="font-semibold">No HC Reason</span> (or no_health_card_reason)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Next of Kin</span> (or next_of_kin, kin) - simple text
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Emergency Contact</span> (or emergency_contact, emergency) - simple text
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Comments</span> (or notes, remarks)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Chart Number</span> (or chart_number, chart)
                            </div>
                        </div>
                    </div>
                    
                    <!-- Program Enrollment Columns -->
                    <div>
                        <h3 class="text-lg font-bold text-neutral-800 font-subheader mb-4">Program Enrollment Columns</h3>
                        <div class="space-y-2">
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-orange-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Program</span> (or program_name, program name, programname)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-orange-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Sub-program</span> (or sub_program, subprogram, sub program)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-orange-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Worker / Support Worker(s)</span> (or support_workers, supportworkers, workers) - comma-separated
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-orange-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Level of Support</span> (or level_of_support, levelofsupport, support level)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-orange-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Client Type</span> (or client_type, clienttype, type)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-orange-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Admission Date</span> (or admission_date, admissiondate, start date, enrollment date)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-orange-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Discharge Date</span> (or discharge_date, dischargedate, end date, exit date)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-orange-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Days Elapsed</span> (or days_elapsed, dayselapsed, days since admission)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-orange-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Program Status</span> (or program_status, programstatus, status)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-orange-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Reason (for Discharge/Program Status)</span> (or reason_discharge, discharge reason, reason)
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-orange-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Receiving Services</span> (or receiving_services, receivingservices, active) - true/false/yes/no/1/0
                            </div>
                            <div class="flex items-center text-sm text-neutral-600 font-body">
                                <div class="w-2 h-2 bg-orange-500 rounded-full mr-3"></div>
                                <span class="font-semibold">Referral Source</span> (or referral_source, referralsource, source)
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Important Notes -->
                <div class="mt-8 pt-6 border-t border-neutral-200">
                    <h3 class="text-lg font-bold text-neutral-800 font-subheader mb-4">Important Notes</h3>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-blue-400 mr-3 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <div class="text-sm text-blue-800">
                                <p class="font-bold mb-2">Key Points:</p>
                                <ul class="space-y-1 text-blue-700">
                                    <li>• <strong>UPDATE FUNCTIONALITY:</strong> If Client ID matches existing client, the record will be updated instead of creating a duplicate</li>
                                    <li>• Only 4 columns are required: <strong>First Name, Last Name, Phone, DOB</strong> (case-insensitive)</li>
                                    <li>• <strong>All column names are case-insensitive</strong> - use any variation shown in parentheses</li>
                                    <li>• <strong>DOB is required</strong> and must be in YYYY-MM-DD format</li>
                                    <li>• Missing <strong>Gender</strong> will default to "Unknown"</li>
                                    <li>• <strong>Email is now optional</strong> - can be included or omitted</li>
                                    <li>• Permission fields accept: true/false/yes/no/1/0 (case insensitive)</li>
                                    <li>• Comma-separated fields: Language, Ethnicity, Support Workers</li>
                                    <li>• Date format: YYYY-MM-DD for all date fields</li>
                                    <li>• Program enrollment fields create automatic enrollments when included</li>
                                    <li>• All other fields are optional and can be added later</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sample Download -->
                <div class="mt-8 pt-6 border-t border-neutral-200">
                    <h3 class="text-lg font-bold text-neutral-800 font-subheader mb-4">Sample Files</h3>
                    <div class="flex space-x-4">
                        <a href="{% url 'clients:download_sample' 'csv' %}" class="inline-flex items-center px-4 py-2 border border-neutral-300 text-sm font-bold rounded-lg text-neutral-700 bg-white hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-sky transition-all duration-200">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Download CSV Sample
                        </a>
                        <a href="{% url 'clients:download_sample' 'xlsx' %}" class="inline-flex items-center px-4 py-2 border border-neutral-300 text-sm font-bold rounded-lg text-neutral-700 bg-white hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-sky transition-all duration-200">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Download Excel Sample
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-neutral-500 bg-opacity-75 transition-opacity" onclick="hideSuccessModal()"></div>
        
        <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-6 pt-6 pb-4">
                <div class="flex items-center">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                        <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-bold text-neutral-900 font-header">Upload Successful!</h3>
                        <p class="text-sm text-neutral-600 font-body">Your client data has been processed successfully.</p>
                    </div>
                </div>
                <div class="mt-4" id="successMessage"></div>
            </div>
            <div class="bg-neutral-50 px-6 py-4 flex justify-end space-x-3">
                <button onclick="hideSuccessModal(); window.location.href = '{% url 'clients:list' %}'" class="px-4 py-2 bg-brand-sky text-white text-sm font-bold rounded-lg hover:bg-brand-darkBlue focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-sky transition-all duration-200">
                    View Clients
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function uploadManager() {
    return {
        isDragging: false,
        fileSelected: false,
        selectedFile: null,
        isUploading: false,
        currentStep: 0,
        successMessage: '',
        errorMessage: '',
        selectedSource: 'SMIMS', // Default to SMIMS
        
        handleFileDrop(event) {
            this.isDragging = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                this.handleFile(files[0]);
            }
        },
        
        handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                this.handleFile(files[0]);
            }
        },
        
        handleFile(file) {
            const allowedTypes = ['text/csv', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
            const allowedExtensions = ['csv', 'xlsx', 'xls'];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
                this.errorMessage = `
                    <div class="space-y-2">
                        <p class="font-semibold">Please select a CSV or Excel file.</p>
                        <p class="text-sm text-red-600">Supported formats: .csv, .xlsx, .xls</p>
                    </div>
                `;
                return;
            }
            
            this.selectedFile = file;
            this.fileSelected = true;
            // Clear any existing error messages when file is selected
            this.errorMessage = '';
        },
        
        openFileDialog() {
            this.$refs.fileInput.click();
        },
        
        clearFile() {
            this.selectedFile = null;
            this.fileSelected = false;
            this.$refs.fileInput.value = '';
        },
        
        formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },
        
        getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        },
        
        async uploadFile() {
            if (!this.selectedFile) {
                this.errorMessage = `
                    <div class="space-y-2">
                        <p class="font-semibold">Please select a file first.</p>
                    </div>
                `;
                return;
            }
            
            // Clear any existing error messages
            this.errorMessage = '';
            this.isUploading = true;
            this.currentStep = 0;
            
            const formData = new FormData();
            formData.append('file', this.selectedFile);
            formData.append('source', this.selectedSource);
            
            try {
                // Simulate progress steps
                this.currentStep = 1;
                await new Promise(resolve => setTimeout(resolve, 500));
                
                this.currentStep = 2;
                await new Promise(resolve => setTimeout(resolve, 500));
                
                this.currentStep = 3;
                await new Promise(resolve => setTimeout(resolve, 500));
                
                this.currentStep = 4;
                
                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                 document.querySelector('meta[name=csrf-token]')?.getAttribute('content') ||
                                 this.getCookie('csrftoken');
                
                const response = await fetch('{% url "clients:upload_process" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Create a more informative message based on results
                    let message = result.message;
                    if (result.stats.duplicates_flagged > 0) {
                        message = `Upload completed! ${result.stats.duplicates_flagged} clients were flagged as potential duplicates for review.`;
                    }
                    
                    this.successMessage = `
                        <div class="mt-4 space-y-3">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 text-green-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-green-800 font-bold">${message}</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                                <div class="bg-neutral-50 rounded-lg p-3">
                                    <div class="text-neutral-600 font-body">Total Rows</div>
                                    <div class="text-2xl font-bold text-neutral-900 font-header">${result.stats.total_rows}</div>
                                </div>
                                <div class="bg-green-50 rounded-lg p-3">
                                    <div class="text-green-600 font-body">Created</div>
                                    <div class="text-2xl font-bold text-green-800 font-header">${result.stats.created}</div>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-3">
                                    <div class="text-blue-600 font-body">Updated</div>
                                    <div class="text-2xl font-bold text-blue-800 font-header">${result.stats.updated}</div>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-3">
                                    <div class="text-yellow-600 font-body">Duplicates Flagged</div>
                                    <div class="text-2xl font-bold text-yellow-800 font-header">${result.stats.duplicates_flagged}</div>
                                </div>
                                <div class="bg-red-50 rounded-lg p-3">
                                    <div class="text-red-600 font-body">Errors</div>
                                    <div class="text-2xl font-bold text-red-800 font-header">${result.stats.errors}</div>
                                </div>
                            </div>
                            ${result.duplicate_details && result.duplicate_details.length > 0 ? `
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 class="font-bold text-blue-800 mb-3">Duplicate Handling Details:</h4>
                                    <div class="space-y-2 max-h-40 overflow-y-auto">
                                        ${result.duplicate_details.map(dup => `
                                            <div class="flex items-start justify-between p-2 bg-white rounded border border-blue-100">
                                                <div class="flex-1">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="text-sm font-bold text-blue-900">${dup.client_name}</span>
                                                        <span class="text-xs px-2 py-1 rounded-full ${dup.type === 'updated' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                            ${dup.type === 'updated' ? 'Updated' : 'Flagged for Review'}
                                                        </span>
                                                    </div>
                                                    <div class="text-xs text-blue-700 mt-1">
                                                        <strong>Reason:</strong> ${dup.reason}
                                                    </div>
                                                    <div class="text-xs text-blue-600 mt-1">
                                                        <strong>Matched with:</strong> ${dup.existing_name}
                                                    </div>
                                                    <div class="text-xs text-blue-500 mt-1">
                                                        <strong>Match field:</strong> ${dup.match_field}
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    ${result.duplicate_details.length >= 20 ? '<p class="text-xs text-blue-600 mt-2">Showing first 20 duplicates...</p>' : ''}
                                </div>
                            ` : ''}
                            ${result.errors && result.errors.length > 0 ? `
                                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                    <h4 class="font-bold text-red-800 mb-2">Errors Found:</h4>
                                    <ul class="text-sm text-red-700 space-y-1">
                                        ${result.errors.map(error => `<li>• ${error}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    // Show success modal
                    document.getElementById('successMessage').innerHTML = this.successMessage;
                    document.getElementById('successModal').style.display = 'block';
                } else {
                    this.errorMessage = `
                        <div class="space-y-2">
                            <p class="font-semibold">${result.error}</p>
                            <div class="text-sm text-red-600">
                                <p><strong>Required columns:</strong> client_id, first_name, last_name, phone, dob</p>
                                <p><strong>Note:</strong> client_id is now required for all uploads (both new and updates)</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Upload error:', error);
                this.errorMessage = `
                    <div class="space-y-2">
                        <p class="font-semibold">Upload failed. Please try again.</p>
                        <p class="text-sm text-red-600">If the problem persists, contact your system administrator.</p>
                    </div>
                `;
            } finally {
                this.isUploading = false;
                this.currentStep = 0;
            }
        }
    }
}

function hideSuccessModal() {
    document.getElementById('successModal').style.display = 'none';
}
</script>
{% endblock %}
